<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>JS Bridge Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    h1 {
      margin-bottom: 20px;
    }
    button {
      margin: 5px;
      padding: 10px 20px;
      font-size: 14px;
      border-radius: 8px;
      border: none;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    /* Always visible query param box */
    #paramDisplay {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      min-width: 300px;
      padding: 20px;
      background: #f8f9fa;
      border: 2px solid #007bff;
      border-radius: 12px;
      box-shadow: 0px 4px 12px rgba(0,0,0,0.2);
      text-align: left;
      white-space: pre-wrap;
    }
    #paramDisplay h2 {
      margin-top: 0;
      font-size: 18px;
      color: #007bff;
    }
  </style>
  <script>
    // ---------------------------
    // LogScreen Payload
    // ---------------------------
    const payload = {
      screenName: "xxxxx",
      errorCode: "xxxxx",
      httpErrorCode: "xxxx",
      event: {
        product: "xxx",
        name: "xxxx",
        label: "",
        ui: "",
        description: ""
      },
      customDimension: [{ key: "", value: "" }],
      firebaseScreen: [{ key: "", value: "" }]
    };

    function sendLogScreen() {
      const body = JSON.stringify(payload);
      console.log("Prepared Payload:", body);

      if (window.webkit?.messageHandlers?.AnalyticsWebInterface) {
        console.log("Sending to iOS bridge...");
        window.webkit.messageHandlers.AnalyticsWebInterface.postMessage({
          name: 'logScreen',
          payload: body
        });
      } else if (window.AnalyticsWebInterface?.logScreen) {
        console.log("Sending to Android bridge...");
        window.AnalyticsWebInterface.logScreen(body);
      } else {
        console.warn("No bridge found. Running fallback.");
        alert("No bridge detected. Check console for payload.");
      }
    }

    // ---------------------------
    // INITIALIZE Flow
    // ---------------------------
    const handleInitializeResponse = (deviceInfo) => {
      console.log("âœ… Received device info from Native:", deviceInfo);
      alert(`Device: ${deviceInfo}`);
    };

    function initializeCoupon() {
      const initPayload = {
        command: "INITIALIZE",
        content: {}
      };
      const body = JSON.stringify(initPayload);

      window.bridge = window.bridge || {};
      window.bridge.initializeCallback = handleInitializeResponse;

      if (window.webkit?.messageHandlers?.nativeInterface) {
        console.log("ðŸ“¤ Sending INITIALIZE to iOS:", body);
        window.webkit.messageHandlers.nativeInterface.postMessage(body);
      } else if (window.nativeInterface?.onRetrievePayloadString) {
        console.log("ðŸ“¤ Sending INITIALIZE to Android:", body);
        window.nativeInterface.onRetrievePayloadString(body);
      } else {
        console.warn("No native bridge found for INITIALIZE. Running fallback.");
        alert("No native bridge detected. Check console for INITIALIZE payload.");
      }
    }

    // ---------------------------
    // ROUTING Flow
    // ---------------------------
    function sendRouting(destination, additionalParams = "") {
      const initPayload = {
        command: "ROUTING",
        content: { destination, additionalParams }
      };
      const body = JSON.stringify(initPayload);

      // Save callback
      window.bridge = window.bridge || {};
      window.bridge.initializeCallback = handleInitializeResponse;

      // Show additional params in center box (if passed)
      if (additionalParams) {
        showParams(additionalParams);
      }

      if (window.webkit?.messageHandlers?.nativeInterface) {
        console.log(`ðŸ“¤ Sending ROUTING to iOS [${destination}]:`, body);
        window.webkit.messageHandlers.nativeInterface.postMessage(body);
      } else if (window.nativeInterface?.onRetrievePayloadString) {
        console.log(`ðŸ“¤ Sending ROUTING to Android [${destination}]:`, body);
        window.nativeInterface.onRetrievePayloadString(body);
      } else {
        console.warn(`No native bridge found for ROUTING [${destination}]. Running fallback.`);
        alert(`No native bridge detected. Check console for ROUTING payload [${destination}].`);
      }
    }

    // Destination functions
    function routeCloseWebview() { sendRouting("CLOSE_WEBVIEW"); }
    function routeBillPaymentLanding() { sendRouting("BILL_PAYMENT_LANDING", "page=tracking&campaignCode=xxx"); }
    function routeTopupLanding() { sendRouting("TOPUP_LANDING"); }
    function routeQrScan() { sendRouting("QR_SCAN"); }
    function routePocketProductHighlight() { sendRouting("POCKET_PRODUCT_HIGHLIGHT"); }
    function routePocketDetail() { sendRouting("POCKET_DETAIL"); }

    // ---------------------------
    // Display URL Query Params
    // ---------------------------
    function showUrlParams() {
      const queryString = window.location.search.substring(1); // remove "?"
      const display = document.getElementById("paramText");

      if (!queryString) {
        display.innerHTML = "No parameters found.";
        return;
      }

      // Format params into key:value
      let formatted = "";
      queryString.split("&").forEach(p => {
        const [key, val] = p.split("=");
        formatted += `${key}: ${decodeURIComponent(val || "")}\n`;
      });

      display.innerHTML = formatted.replace(/\n/g, "<br>");
    }

    function showParams(params) {
      const display = document.getElementById("paramText");
      let formatted = "";
      params.split("&").forEach(p => {
        const [key, val] = p.split("=");
        formatted += `${key}: ${decodeURIComponent(val || "")}\n`;
      });
      display.innerHTML = formatted.replace(/\n/g, "<br>");
    }

    window.onload = showUrlParams;
  </script>
</head>
<body>
<h1>JS Bridge Test</h1>
<button onclick="sendLogScreen()">Send LogScreen Event</button><br>
<button onclick="initializeCoupon()">Initialize Coupon</button><br>
<button onclick="routeCloseWebview()">Close</button><br>
<button onclick="routeBillPaymentLanding()">BillPay</button><br>
<button onclick="routeTopupLanding()">TopUp</button><br>
<button onclick="routeQrScan()">Scan</button><br>
<button onclick="routePocketProductHighlight()">PDHL</button><br>
<button onclick="routePocketDetail()">PocketDetail</button><br>

<!-- Always visible param display -->
<div id="paramDisplay">
  <h2>URL Query Parameters</h2>
  <p id="paramText">Loading parameters...</p>
</div>
</body>
</html>
