<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>JS Bridge Test</title>
  <script>
    // Define the payload
    const payload = {
      "screenName": "xxxxx",
      "errorCode": "xxxxx",
      "httpErrorCode": "xxxx",
      "event": {
        "product": "xxx",
        "name": "xxxx",
        "label": "",
        "ui": "",
        "description": ""
      },
      "customDimension": [
        {
          "key": "",
          "value": ""
        }
      ],
      "firebaseScreen": [
        {
          "key": "",
          "value": ""
        }
      ]
    };

    // Function to send payload via bridge
    function sendLogScreen() {
      const body = JSON.stringify(payload);
      console.log("Prepared Payload:", body);

      if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.AnalyticsWebInterface) {
        console.log("Sending to iOS bridge...");
        window.webkit.messageHandlers.AnalyticsWebInterface.postMessage({
          name: 'logScreen',
          payload: body
        });
      } else if (window.AnalyticsWebInterface && window.AnalyticsWebInterface.logScreen) {
        console.log("Sending to Android bridge...");
        window.AnalyticsWebInterface.logScreen(body);
      } else {
        console.warn("No bridge found. Running fallback.");
        alert("No bridge detected. Check console for payload.");
      }
    }

    // ---------------------------
    // Coupon INITIALIZE flow
    // ---------------------------

    // Example callback when native responds
    const handleInitializeResponse = (deviceInfo) => {
      console.log("âœ… Received device info from Native:", deviceInfo);
      alert(`Device: ${deviceInfo}`);
    };

    function initializeCoupon() {
      // Build INITIALIZE payload
      const initPayload = {
        command: "INITIALIZE",
        content: {}
      };
      const body = JSON.stringify(initPayload);

      // Save callback
      window.bridge = window.bridge || {};
      window.bridge.initializeCallback = handleInitializeResponse;

      if (window.webkit?.messageHandlers?.nativeInterface) {
        console.log("ðŸ“¤ Sending INITIALIZE to iOS:", body);
        window.webkit.messageHandlers.nativeInterface.postMessage(body);
      } else if (window.nativeInterface?.onRetrievePayloadString) {
        console.log("ðŸ“¤ Sending INITIALIZE to Android:", body);
        window.nativeInterface.onRetrievePayloadString(body);
      } else {
        console.warn("No native bridge found for INITIALIZE. Running fallback.");
        alert("No native bridge detected. Check console for INITIALIZE payload.");
      }
    }

    // ---------------------------
    // Coupon ROUNTING flow
    // ---------------------------

    // Generic function to send ROUTING payload
function sendRouting(destination, additionalParams = "") {
  // Build ROUTING payload
  const initPayload = {
    command: "ROUTING",
    content: {
      destination: destination,
      additionalParams: additionalParams
    }
  };
  const body = JSON.stringify(initPayload);

  // Save callback
  window.bridge = window.bridge || {};
  window.bridge.initializeCallback = handleInitializeResponse;

  // Send to native
  if (window.webkit?.messageHandlers?.nativeInterface) {
    console.log(`ðŸ“¤ Sending ROUTING to iOS [${destination}]:`, body);
    window.webkit.messageHandlers.nativeInterface.postMessage(body);
  } else if (window.nativeInterface?.onRetrievePayloadString) {
    console.log(`ðŸ“¤ Sending ROUTING to Android [${destination}]:`, body);
    window.nativeInterface.onRetrievePayloadString(body);
  } else {
    console.warn(`No native bridge found for ROUTING [${destination}]. Running fallback.`);
    alert(`No native bridge detected. Check console for ROUTING payload [${destination}].`);
  }
}

// Specific functions for each destination
function routeCloseWebview() {
  sendRouting("CLOSE_WEBVIEW");
}

function routeBillPaymentLanding() {
  sendRouting("BILL_PAYMENT_LANDING", "page=tracking&campaignCode=xxx");
}

function routeTopupLanding() {
  sendRouting("TOPUP_LANDING");
}

function routeQrScan() {
  sendRouting("QR_SCAN");
}

function routePocketProductHighlight() {
  sendRouting("POCKET_PRODUCT_HIGHLIGHT");
}

function routePocketDetail() {
  sendRouting("POCKET_DETAIL");
}
  </script>
</head>
<body>
  <h1>JS Bridge Test</h1>
  <button onclick="sendLogScreen()">Send LogScreen Event</button>
  <button onclick="initializeCoupon()">Initialize Coupon</button>
  <button onclick="routeCloseWebview()">Close</button>
  <button onclick="routeBillPaymentLanding()">BillPay</button>
  <button onclick="routeTopupLanding()">TopUp</button>
  <button onclick="routeQrScan()">Scan</button>
  <button onclick="routePocketProductHighlight()">PDHL</button>
  <button onclick="routePocketDetail()">PocketDetail</button>
</body>
</html>